<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cutie Cafe Kitchen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --pink-100: #fce7f3;
            --pink-200: #fbcfe8;
            --pink-300: #f9a8d4;
            --pink-400: #f472b6;
            --pink-500: #ec4899;
            --cream: #fff8f0;
            --mint: #d1fae5;
            --kitchen-bg: #c8e6c9;
            --dining-bg: #fff3e0;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, var(--pink-100) 0%, var(--cream) 100%);
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        /* CHARACTER SELECTION SCREEN */
        #charSelect {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fff1f2 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        #charSelect.hidden {
            display: none;
        }

        .select-title {
            font-family: 'Pacifico', cursive;
            font-size: clamp(28px, 6vw, 48px);
            color: var(--pink-500);
            text-shadow: 2px 2px 0 white, 4px 4px 0 var(--pink-200);
            margin-bottom: 10px;
            text-align: center;
        }

        .select-subtitle {
            font-size: 16px;
            color: #888;
            margin-bottom: 20px;
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            max-width: 600px;
            width: 100%;
            padding: 10px;
        }

        .char-option {
            aspect-ratio: 1;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid transparent;
            padding: 8px;
        }

        .char-option:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(236,72,153,0.3);
            border-color: var(--pink-400);
        }

        .char-option img {
            width: 90%;
            height: 90%;
            object-fit: contain;
        }

        /* GAME CONTAINER */
        #gameContainer {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #gameContainer.active {
            display: block;
        }

        /* HUD */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.8) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--pink-300);
        }

        .hud-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hud-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hud-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--pink-500);
        }

        .hud-icon {
            font-size: 24px;
        }

        #dayTimer {
            width: 120px;
            height: 8px;
            background: var(--pink-100);
            border-radius: 4px;
            overflow: hidden;
        }

        #dayTimerFill {
            height: 100%;
            background: linear-gradient(90deg, var(--pink-400), var(--pink-500));
            transition: width 0.1s linear;
        }

        /* GAME WORLD */
        #gameWorld {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }

        /* PLAYER INVENTORY */
        #inventory {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border: 3px solid var(--pink-300);
            z-index: 100;
        }

        .inv-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        #invItems {
            display: flex;
            gap: 8px;
            min-width: 100px;
            min-height: 40px;
            align-items: center;
        }

        .inv-item {
            width: 40px;
            height: 40px;
            background: var(--pink-100);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .inv-item img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        #invPlate {
            width: 50px;
            height: 50px;
            background: var(--cream);
            border-radius: 50%;
            border: 3px dashed var(--pink-300);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #invPlate.has-plate {
            border-style: solid;
            background: white;
        }

        #invPlate img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        /* MOBILE CONTROLS */
        #mobileControls {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 20px;
            z-index: 100;
        }

        @media (max-width: 768px) {
            #mobileControls {
                display: block;
            }
        }

        .dpad {
            width: 140px;
            height: 140px;
            position: relative;
        }

        .dpad-btn {
            position: absolute;
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.9);
            border: 3px solid var(--pink-300);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--pink-500);
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .dpad-btn:active {
            background: var(--pink-200);
            transform: scale(0.95);
        }

        .dpad-up { top: 0; left: 50%; transform: translateX(-50%); }
        .dpad-down { bottom: 0; left: 50%; transform: translateX(-50%); }
        .dpad-left { left: 0; top: 50%; transform: translateY(-50%); }
        .dpad-right { right: 0; top: 50%; transform: translateY(-50%); }

        #actionBtn {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--pink-400), var(--pink-500));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Quicksand', sans-serif;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(236,72,153,0.4);
            display: none;
            z-index: 100;
        }

        @media (max-width: 768px) {
            #actionBtn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* INTERACTION PROMPT */
        #interactPrompt {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--pink-500);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--pink-300);
            display: none;
            z-index: 100;
            white-space: nowrap;
        }

        #interactPrompt.show {
            display: block;
            animation: promptBounce 0.3s ease-out;
        }

        @keyframes promptBounce {
            0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }

        /* DAY COMPLETE OVERLAY */
        #dayComplete {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        #dayComplete.show {
            display: flex;
        }

        .day-modal {
            background: white;
            border-radius: 32px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            animation: modalPop 0.4s ease-out;
        }

        @keyframes modalPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .day-modal h2 {
            font-family: 'Pacifico', cursive;
            font-size: 36px;
            color: var(--pink-500);
            margin-bottom: 20px;
        }

        .day-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .day-stat {
            text-align: center;
        }

        .day-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--pink-500);
        }

        .day-stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        .next-day-btn {
            background: linear-gradient(135deg, var(--pink-400), var(--pink-500));
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Quicksand', sans-serif;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .next-day-btn:hover {
            transform: scale(1.05);
        }

        /* WIN SCREEN */
        #winScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 300;
        }

        #winScreen.show {
            display: flex;
        }

        .win-title {
            font-family: 'Pacifico', cursive;
            font-size: 48px;
            color: var(--pink-500);
            margin-bottom: 20px;
        }

        .win-message {
            font-size: 72px;
            margin: 20px 0;
        }

        .win-subtitle {
            font-size: 24px;
            color: #666;
        }

        /* INSTRUCTIONS */
        .instructions {
            position: fixed;
            top: 70px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 11px;
            color: #666;
            z-index: 90;
            max-width: 180px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .instructions kbd {
            background: var(--pink-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
        }

        @media (max-width: 768px) {
            .instructions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Background Music -->
    <audio id="bgm" loop>
        <source src="music__20260102_114131.mp3" type="audio/mpeg">
    </audio>
    <button id="musicToggle" onclick="toggleMusic()" style="
        position: fixed;
        top: 70px;
        left: 10px;
        z-index: 9999;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #f472b6, #ec4899);
        color: white;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
    ">üîá</button>
    <script>
        let musicPlaying = false;
        function toggleMusic() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('musicToggle');
            if (musicPlaying) {
                bgm.pause();
                btn.textContent = 'üîá';
                musicPlaying = false;
            } else {
                bgm.play();
                btn.textContent = 'üîä';
                musicPlaying = true;
            }
        }
        document.addEventListener('click', function autoPlay() {
            if (!musicPlaying) {
                document.getElementById('bgm').play().then(() => {
                    musicPlaying = true;
                    document.getElementById('musicToggle').textContent = 'üîä';
                }).catch(() => {});
            }
            document.removeEventListener('click', autoPlay);
        }, { once: true });
    </script>

    <!-- CHARACTER SELECTION -->
    <div id="charSelect">
        <h1 class="select-title">Cutie Cafe Kitchen!</h1>
        <p class="select-subtitle">Pick your character to start cooking!</p>
        <p id="loadingText" style="color: #888; margin-bottom: 20px;">Loading characters...</p>
        <div class="char-grid" id="charGrid"></div>
    </div>

    <!-- GAME -->
    <div id="gameContainer">
        <!-- HUD -->
        <div id="hud">
            <div class="hud-section">
                <span class="hud-icon">üìÖ</span>
                <div>
                    <div class="hud-label">Day</div>
                    <div class="hud-value" id="dayNum">1</div>
                </div>
            </div>
            <div class="hud-section">
                <div id="dayTimer"><div id="dayTimerFill" style="width: 100%"></div></div>
            </div>
            <div class="hud-section">
                <span class="hud-icon">üí∞</span>
                <div>
                    <div class="hud-label">Tips</div>
                    <div class="hud-value">$<span id="tips">0</span></div>
                </div>
            </div>
            <div class="hud-section">
                <span class="hud-icon">‚≠ê</span>
                <div>
                    <div class="hud-label">Served</div>
                    <div class="hud-value" id="served">0</div>
                </div>
            </div>
        </div>

        <!-- GAME WORLD -->
        <div id="gameWorld">
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- INVENTORY -->
        <div id="inventory">
            <div>
                <div class="inv-label">Holding</div>
                <div id="invItems"></div>
            </div>
            <div id="invPlate"></div>
        </div>

        <!-- INTERACTION PROMPT -->
        <div id="interactPrompt"></div>

        <!-- MOBILE CONTROLS -->
        <div id="mobileControls">
            <div class="dpad">
                <div class="dpad-btn dpad-up" data-dir="up">‚ñ≤</div>
                <div class="dpad-btn dpad-down" data-dir="down">‚ñº</div>
                <div class="dpad-btn dpad-left" data-dir="left">‚óÄ</div>
                <div class="dpad-btn dpad-right" data-dir="right">‚ñ∂</div>
            </div>
        </div>
        <button id="actionBtn">ACTION<br>‚ö°</button>

        <!-- INSTRUCTIONS -->
        <div class="instructions">
            <strong>Controls:</strong><br>
            <kbd>WASD</kbd> or <kbd>Arrows</kbd> = Move<br>
            <kbd>Space</kbd> or <kbd>E</kbd> = Interact
        </div>
    </div>

    <!-- DAY COMPLETE -->
    <div id="dayComplete">
        <div class="day-modal">
            <h2>Day Complete!</h2>
            <div class="day-stats">
                <div class="day-stat">
                    <div class="day-stat-value" id="dayServed">0</div>
                    <div class="day-stat-label">Served</div>
                </div>
                <div class="day-stat">
                    <div class="day-stat-value" id="dayTips">$0</div>
                    <div class="day-stat-label">Tips</div>
                </div>
            </div>
            <button class="next-day-btn" onclick="startNextDay()">Next Day ‚Üí</button>
        </div>
    </div>

    <!-- WIN SCREEN -->
    <div id="winScreen">
        <div class="win-title">You Did It!</div>
        <div class="win-message">ÏÇ¨ÎûëÌï¥ üíï</div>
        <div class="win-subtitle">10 Days Complete!</div>
    </div>

    <script>
        // ==========================================
        // GAME CONFIGURATION - MUCH MORE SPACE
        // ==========================================
        const CONFIG = {
            WORLD_WIDTH: 2400,  // Wider for ultrawide
            WORLD_HEIGHT: 1000,
            TILE_SIZE: 80,
            PLAYER_SPEED: 6,
            PLAYER_SIZE: 60,
            STATION_SIZE: 80,
            TABLE_SIZE: 90,
            INTERACT_DIST: 80,
            DAY_LENGTH: 120000,
            MAX_DAYS: 10
        };

        // Characters
        const characters = [
            'hello-kitty', 'cinnamoroll', 'my-melody', 'kuromi', 'pompompurin',
            'gudetama', 'pochacco', 'keroppi', 'badtz-maru', 'chococat',
            'tuxedosam', 'corocorokuririn', 'moomin', 'hamtaro', 'bijou',
            'oxnard', 'boss', 'pashmina', 'penelope', 'mametchi',
            'kuchipatchi', 'memetchi'
        ];

        // Recipes
        const recipes = {
            toast: { ingredients: ['bread'], cookTime: 2000, name: 'Toast', tip: 3 },
            friedEgg: { ingredients: ['egg'], cookTime: 3000, name: 'Fried Egg', tip: 4 },
            salad: { ingredients: ['lettuce', 'tomato'], cookTime: 2500, name: 'Salad', tip: 6 },
            sandwich: { ingredients: ['bread', 'cheese', 'lettuce'], cookTime: 4000, name: 'Sandwich', tip: 8 },
            breakfast: { ingredients: ['egg', 'bacon', 'bread'], cookTime: 5000, name: 'Breakfast', tip: 10 },
            cheeseToast: { ingredients: ['bread', 'cheese'], cookTime: 3000, name: 'Cheese Toast', tip: 5 },
            baconEgg: { ingredients: ['egg', 'bacon'], cookTime: 4000, name: 'Bacon & Egg', tip: 7 },
            riceBowl: { ingredients: ['rice', 'egg'], cookTime: 3500, name: 'Rice Bowl', tip: 6 },
            cake: { ingredients: ['cake', 'strawberry'], cookTime: 4500, name: 'Strawberry Cake', tip: 9 },
            coffee: { ingredients: ['coffee'], cookTime: 2000, name: 'Coffee', tip: 4 },
            blt: { ingredients: ['bread', 'bacon', 'lettuce', 'tomato'], cookTime: 5500, name: 'BLT', tip: 12 },
            veggiePlate: { ingredients: ['lettuce', 'tomato', 'cheese'], cookTime: 3000, name: 'Veggie Plate', tip: 7 }
        };

        const ingredientTypes = ['bread', 'egg', 'cheese', 'bacon', 'lettuce', 'tomato', 'rice', 'cake', 'strawberry', 'coffee'];

        // ==========================================
        // GAME STATE
        // ==========================================
        let gameState = {
            running: false,
            day: 1,
            dayTimer: CONFIG.DAY_LENGTH,
            tips: 0,
            served: 0,
            dayServed: 0,
            dayTips: 0
        };

        let player = {
            x: 350,
            y: 450,
            character: null,
            holding: [],
            hasPlate: false,
            platedDish: null
        };

        let keys = { up: false, down: false, left: false, right: false };
        let stations = [];
        let tables = [];
        let customers = [];
        let cookingStations = new Map();

        // Images cache
        const images = {};
        let imagesLoaded = 0;
        let totalImages = 0;

        // Canvas
        let canvas, ctx;
        let cameraX = 0, cameraY = 0;
        let lastTime = 0;

        // ==========================================
        // IMAGE LOADING
        // ==========================================
        function loadImage(name, src) {
            totalImages++;
            const img = new Image();
            img.onload = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) initGame();
            };
            img.onerror = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) initGame();
            };
            img.src = src;
            images[name] = img;
        }

        function loadAllImages() {
            characters.forEach(c => loadImage(c, `images/${c}.svg`));
            loadImage('stove', 'images/stove.svg');
            loadImage('oven', 'images/oven.svg');
            loadImage('cutting-board', 'images/cutting-board.svg');
            loadImage('prep-counter', 'images/prep-counter.svg');
            loadImage('plate-stack', 'images/plate-stack.svg');
            loadImage('trash-bin', 'images/trash-bin.svg');
            loadImage('serving-counter', 'images/serving-counter.svg');
            loadImage('fridge', 'images/fridge.svg');
            loadImage('coffee-machine', 'images/coffee-machine.svg');
            loadImage('ingredient-shelf', 'images/ingredient-shelf.svg');
            loadImage('cafe-table', 'images/cafe-table.svg');
            loadImage('cafe-chair', 'images/cafe-chair.svg');
            ingredientTypes.forEach(i => loadImage(`food-${i}`, `images/food-${i}.svg`));
            loadImage('dish-toast', 'images/dish-toast.svg');
            loadImage('dish-fried-egg', 'images/dish-fried-egg.svg');
            loadImage('dish-salad', 'images/dish-salad.svg');
            loadImage('dish-sandwich', 'images/dish-sandwich.svg');
            loadImage('dish-breakfast', 'images/dish-breakfast.svg');
            loadImage('dish-cheese-toast', 'images/dish-cheese-toast.svg');
            loadImage('dish-strawberry-cake', 'images/dish-strawberry-cake.svg');
            loadImage('plate', 'images/plate.svg');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        function initCharacterSelect() {
            console.log('initCharacterSelect called');
            const grid = document.getElementById('charGrid');
            const loadingText = document.getElementById('loadingText');
            grid.innerHTML = '';
            characters.forEach(char => {
                const div = document.createElement('div');
                div.className = 'char-option';
                div.innerHTML = `<img src="images/${char}.svg" alt="${char}">`;
                div.onclick = () => selectCharacter(char);
                grid.appendChild(div);
            });
            if (loadingText) loadingText.style.display = 'none';
            console.log('Characters added:', characters.length);
        }

        function selectCharacter(char) {
            player.character = char;
            document.getElementById('charSelect').classList.add('hidden');
            document.getElementById('gameContainer').classList.add('active');
            startGame();
        }

        function initGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            createStations();
            createTables();
            setupInput();
            initCharacterSelect();
        }

        function resizeCanvas() {
            const world = document.getElementById('gameWorld');
            canvas.width = world.clientWidth;
            canvas.height = world.clientHeight;
        }

        function createStations() {
            stations = [];
            const S = CONFIG.STATION_SIZE;
            const gap = 120; // More space between stations

            // Kitchen area - top section (cooking)
            stations.push({ type: 'stove', x: 80, y: 80, w: S, h: S, canCook: true });
            stations.push({ type: 'stove', x: 80 + gap, y: 80, w: S, h: S, canCook: true });
            stations.push({ type: 'oven', x: 80 + gap * 2, y: 80, w: S, h: S, canCook: true });
            stations.push({ type: 'coffee-machine', x: 80 + gap * 3, y: 80, w: S, h: S, canCook: true });

            // Middle section (prep)
            stations.push({ type: 'cutting-board', x: 80, y: 80 + gap, w: S, h: S, canCook: true });
            stations.push({ type: 'prep-counter', x: 80 + gap, y: 80 + gap, w: S, h: S, canCook: true });
            stations.push({ type: 'prep-counter', x: 80 + gap * 2, y: 80 + gap, w: S, h: S, canCook: true });
            stations.push({ type: 'fridge', x: 80 + gap * 3, y: 80 + gap, w: S, h: S });

            // Bottom section (utility)
            stations.push({ type: 'plate-stack', x: 80, y: 80 + gap * 2, w: S, h: S });
            stations.push({ type: 'trash-bin', x: 80 + gap, y: 80 + gap * 2, w: S, h: S });
            stations.push({ type: 'serving-counter', x: 80 + gap * 2, y: 80 + gap * 2, w: S, h: S });

            // Ingredients row (very bottom of kitchen)
            const ingY = 80 + gap * 3 + 40;
            ingredientTypes.forEach((ing, i) => {
                stations.push({
                    type: 'ingredient',
                    ingredient: ing,
                    x: 50 + i * 100,
                    y: ingY,
                    w: S,
                    h: S
                });
            });
        }

        function createTables() {
            tables = [];
            const startX = 700;
            const startY = 100;
            const gapX = 350;  // More horizontal space for ultrawide
            const gapY = 220;

            // 4x2 grid of tables spread across dining area
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {  // 4 columns now
                    const tx = startX + col * gapX;
                    const ty = 100 + row * gapY;
                    tables.push({
                        x: tx,
                        y: ty,
                        w: CONFIG.TABLE_SIZE,
                        h: CONFIG.TABLE_SIZE,
                        customer: null,
                        chairLeft: { x: tx - 50, y: ty + 20 },
                        chairRight: { x: tx + CONFIG.TABLE_SIZE + 10, y: ty + 20 }
                    });
                }
            }
        }

        // ==========================================
        // GAME LOOP
        // ==========================================
        function startGame() {
            gameState.running = true;
            gameState.day = 1;
            gameState.tips = 0;
            gameState.served = 0;
            resetDay();
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            spawnCustomerLoop();
        }

        function resetDay() {
            gameState.dayTimer = CONFIG.DAY_LENGTH;
            gameState.dayServed = 0;
            gameState.dayTips = 0;
            customers = [];
            cookingStations.clear();
            player.x = 350;
            player.y = 450;
            player.holding = [];
            player.hasPlate = false;
            player.platedDish = null;
            updateHUD();
            updateInventoryUI();
        }

        function gameLoop(timestamp) {
            if (!gameState.running) return;

            const dt = timestamp - lastTime;
            lastTime = timestamp;

            update(dt);
            render();

            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            movePlayer();
            updateCamera();

            gameState.dayTimer -= dt;
            if (gameState.dayTimer <= 0) {
                endDay();
                return;
            }

            updateCooking(dt);
            updateCustomers(dt);
            updateHUD();
            checkInteractions();
        }

        function movePlayer() {
            let dx = 0, dy = 0;
            if (keys.up) dy -= CONFIG.PLAYER_SPEED;
            if (keys.down) dy += CONFIG.PLAYER_SPEED;
            if (keys.left) dx -= CONFIG.PLAYER_SPEED;
            if (keys.right) dx += CONFIG.PLAYER_SPEED;

            if (dx !== 0 && dy !== 0) {
                dx *= 0.707;
                dy *= 0.707;
            }

            const newX = player.x + dx;
            const newY = player.y + dy;
            const half = CONFIG.PLAYER_SIZE / 2;

            if (newX > half && newX < CONFIG.WORLD_WIDTH - half) player.x = newX;
            if (newY > half && newY < CONFIG.WORLD_HEIGHT - half) player.y = newY;
        }

        function updateCamera() {
            const targetX = player.x - canvas.width / 2;
            const targetY = player.y - canvas.height / 2;
            cameraX = Math.max(0, Math.min(targetX, CONFIG.WORLD_WIDTH - canvas.width));
            cameraY = Math.max(0, Math.min(targetY, CONFIG.WORLD_HEIGHT - canvas.height));
        }

        function updateCooking(dt) {
            cookingStations.forEach((cooking) => {
                if (cooking.recipe && cooking.progress < cooking.recipe.cookTime) {
                    cooking.progress += dt;
                }
            });
        }

        function updateCustomers(dt) {
            customers.forEach(c => {
                if (c.patience > 0 && !c.served) {
                    c.patience -= dt;
                    if (c.patience <= 0) {
                        c.patience = 0;
                        c.angry = true;
                    }
                }
            });

            customers = customers.filter(c => {
                if (c.angry) {
                    c.leaveTimer = (c.leaveTimer || 0) + dt;
                    if (c.leaveTimer > 2000) {
                        const table = tables.find(t => t.customer === c);
                        if (table) table.customer = null;
                        return false;
                    }
                }
                if (c.served) {
                    c.leaveTimer = (c.leaveTimer || 0) + dt;
                    if (c.leaveTimer > 1500) {
                        const table = tables.find(t => t.customer === c);
                        if (table) table.customer = null;
                        return false;
                    }
                }
                return true;
            });
        }

        function updateHUD() {
            document.getElementById('dayNum').textContent = gameState.day;
            document.getElementById('tips').textContent = gameState.tips;
            document.getElementById('served').textContent = gameState.served;
            const pct = (gameState.dayTimer / CONFIG.DAY_LENGTH) * 100;
            document.getElementById('dayTimerFill').style.width = pct + '%';
        }

        // ==========================================
        // RENDERING - OPTIMIZED
        // ==========================================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-cameraX, -cameraY);

            drawBackground();
            drawStations();
            drawTables();
            drawCustomers();
            drawCookingProgress();
            drawPlayer();

            ctx.restore();
        }

        function drawBackground() {
            const kitchenWidth = 650;  // Wider kitchen

            // Kitchen (left - green)
            ctx.fillStyle = '#c8e6c9';
            ctx.fillRect(0, 0, kitchenWidth, CONFIG.WORLD_HEIGHT);
            ctx.strokeStyle = '#81c784';
            ctx.lineWidth = 4;
            ctx.strokeRect(2, 2, kitchenWidth - 4, CONFIG.WORLD_HEIGHT - 4);

            // Kitchen grid
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            for (let x = 0; x < kitchenWidth; x += 60) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, CONFIG.WORLD_HEIGHT);
                ctx.stroke();
            }
            for (let y = 0; y < CONFIG.WORLD_HEIGHT; y += 60) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(kitchenWidth, y);
                ctx.stroke();
            }

            // Dining (right - cream)
            ctx.fillStyle = '#fff3e0';
            ctx.fillRect(kitchenWidth, 0, CONFIG.WORLD_WIDTH - kitchenWidth, CONFIG.WORLD_HEIGHT);

            // Dining decorations
            ctx.fillStyle = 'rgba(255,224,178,0.4)';
            for (let x = 580; x < CONFIG.WORLD_WIDTH; x += 80) {
                for (let y = 20; y < CONFIG.WORLD_HEIGHT; y += 80) {
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        function drawStations() {
            stations.forEach(s => {
                const img = s.type === 'ingredient' ? images[`food-${s.ingredient}`] : images[s.type];
                if (img) {
                    ctx.drawImage(img, s.x, s.y, s.w, s.h);
                } else {
                    ctx.fillStyle = '#ddd';
                    ctx.fillRect(s.x, s.y, s.w, s.h);
                }

                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.font = '11px Quicksand';
                ctx.textAlign = 'center';
                const label = s.type === 'ingredient' ? s.ingredient : s.type.replace(/-/g, ' ');
                ctx.fillText(label, s.x + s.w / 2, s.y + s.h + 14);
            });
        }

        function drawTables() {
            tables.forEach(t => {
                // Chairs
                if (images['cafe-chair']) {
                    ctx.drawImage(images['cafe-chair'], t.chairLeft.x, t.chairLeft.y, 45, 45);
                    ctx.save();
                    ctx.translate(t.chairRight.x + 22, t.chairRight.y + 22);
                    ctx.scale(-1, 1);
                    ctx.drawImage(images['cafe-chair'], -22, -22, 45, 45);
                    ctx.restore();
                }
                // Table
                if (images['cafe-table']) {
                    ctx.drawImage(images['cafe-table'], t.x, t.y, t.w, t.h);
                }
            });
        }

        function drawCustomers() {
            customers.forEach(c => {
                const table = tables.find(t => t.customer === c);
                if (!table) return;

                // Customer
                const charImg = images[c.character];
                if (charImg) {
                    ctx.drawImage(charImg, table.chairLeft.x - 5, table.chairLeft.y - 15, 55, 55);
                }

                // Order bubble
                if (!c.served && c.order) {
                    const bx = table.x + table.w / 2 - 45;
                    const by = table.y - 55;

                    ctx.fillStyle = 'white';
                    ctx.strokeStyle = c.angry ? '#ef4444' : '#f9a8d4';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.roundRect(bx, by, 90, 50, 12);
                    ctx.fill();
                    ctx.stroke();

                    const dishImg = getDishImage(c.order);
                    if (dishImg) ctx.drawImage(dishImg, bx + 5, by + 7, 38, 38);

                    // Patience bar
                    const pct = c.patience / c.maxPatience;
                    ctx.fillStyle = '#eee';
                    ctx.fillRect(bx + 48, by + 18, 35, 7);
                    ctx.fillStyle = pct > 0.5 ? '#22c55e' : pct > 0.25 ? '#f59e0b' : '#ef4444';
                    ctx.fillRect(bx + 48, by + 18, 35 * pct, 7);
                }

                if (c.served) {
                    ctx.font = '28px sans-serif';
                    ctx.fillText('üòã', table.x + table.w / 2 - 14, table.y - 10);
                }
            });
        }

        function drawCookingProgress() {
            cookingStations.forEach((cooking, station) => {
                if (cooking.recipe) {
                    const pct = Math.min(cooking.progress / cooking.recipe.cookTime, 1);
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.fillRect(station.x, station.y - 18, 70, 10);
                    ctx.fillStyle = pct < 1 ? '#f97316' : '#22c55e';
                    ctx.fillRect(station.x, station.y - 18, 70 * pct, 10);
                    ctx.strokeStyle = '#ccc';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(station.x, station.y - 18, 70, 10);

                    if (pct >= 1) {
                        ctx.font = '22px sans-serif';
                        ctx.fillText('‚ú®', station.x + station.w / 2 - 11, station.y - 5);
                    }
                }
            });
        }

        function drawPlayer() {
            const img = images[player.character];
            if (!img) return;

            const size = CONFIG.PLAYER_SIZE;
            ctx.drawImage(img, player.x - size / 2, player.y - size / 2, size, size);

            // What player is holding
            if (player.holding.length > 0 || player.hasPlate || player.platedDish) {
                const ox = player.x - 25;
                const oy = player.y - size / 2 - 30;

                if (player.platedDish) {
                    const dishImg = getDishImage(player.platedDish);
                    if (dishImg) ctx.drawImage(dishImg, ox, oy, 35, 35);
                } else if (player.hasPlate) {
                    if (images['plate']) ctx.drawImage(images['plate'], ox, oy, 35, 35);
                    player.holding.forEach((ing, i) => {
                        const ingImg = images[`food-${ing}`];
                        if (ingImg) ctx.drawImage(ingImg, ox + 12 + i * 14, oy - 12, 22, 22);
                    });
                } else {
                    player.holding.forEach((ing, i) => {
                        const ingImg = images[`food-${ing}`];
                        if (ingImg) ctx.drawImage(ingImg, ox + i * 20, oy, 28, 28);
                    });
                }
            }
        }

        function getDishImage(name) {
            const map = {
                toast: 'dish-toast', friedEgg: 'dish-fried-egg', salad: 'dish-salad',
                sandwich: 'dish-sandwich', breakfast: 'dish-breakfast', cheeseToast: 'dish-cheese-toast',
                baconEgg: 'dish-fried-egg', riceBowl: 'dish-fried-egg', cake: 'dish-strawberry-cake',
                coffee: 'dish-toast', blt: 'dish-sandwich', veggiePlate: 'dish-salad'
            };
            return images[map[name]] || images['plate'];
        }

        // ==========================================
        // INTERACTIONS
        // ==========================================
        function checkInteractions() {
            const prompt = document.getElementById('interactPrompt');
            let nearest = null;
            let nearestDist = CONFIG.INTERACT_DIST;

            stations.forEach(s => {
                const d = getDistance(player.x, player.y, s.x + s.w / 2, s.y + s.h / 2);
                if (d < nearestDist) {
                    nearestDist = d;
                    nearest = { type: 'station', station: s };
                }
            });

            tables.forEach(t => {
                if (t.customer && !t.customer.served) {
                    const d = getDistance(player.x, player.y, t.x + t.w / 2, t.y + t.h / 2);
                    if (d < nearestDist) {
                        nearestDist = d;
                        nearest = { type: 'table', table: t };
                    }
                }
            });

            if (nearest) {
                prompt.classList.add('show');
                prompt.textContent = nearest.type === 'station' ? getStationPrompt(nearest.station) : 'Press SPACE to serve';
            } else {
                prompt.classList.remove('show');
            }

            window.currentInteraction = nearest;
        }

        function getStationPrompt(s) {
            if (s.type === 'ingredient') return `Pick up ${s.ingredient}`;
            if (s.type === 'plate-stack') return player.hasPlate ? 'Already have plate' : 'Grab plate';
            if (s.type === 'trash-bin') return 'Throw away';
            if (s.canCook) {
                const c = cookingStations.get(s);
                if (c && c.recipe && c.progress >= c.recipe.cookTime) return `Pick up ${c.recipe.name}`;
                if (player.holding.length > 0) return 'Cook ingredients';
            }
            return 'Interact';
        }

        function interact() {
            const i = window.currentInteraction;
            if (!i) return;
            if (i.type === 'station') interactStation(i.station);
            else if (i.type === 'table') serveTable(i.table);
            updateInventoryUI();
        }

        function interactStation(s) {
            if (s.type === 'ingredient') {
                if (player.holding.length < 4) player.holding.push(s.ingredient);
                return;
            }
            if (s.type === 'plate-stack') {
                if (!player.hasPlate && !player.platedDish) player.hasPlate = true;
                return;
            }
            if (s.type === 'trash-bin') {
                player.holding = [];
                player.hasPlate = false;
                player.platedDish = null;
                return;
            }
            if (s.canCook) {
                const c = cookingStations.get(s);
                if (c && c.recipe && c.progress >= c.recipe.cookTime) {
                    if (player.hasPlate && !player.platedDish) {
                        player.platedDish = c.recipeName;
                        player.holding = [];
                        cookingStations.delete(s);
                    }
                    return;
                }
                if (player.holding.length > 0 && !c) {
                    const recipe = findRecipe(player.holding);
                    if (recipe) {
                        cookingStations.set(s, { ingredients: [...player.holding], progress: 0, recipe: recipe.recipe, recipeName: recipe.name });
                        player.holding = [];
                    }
                }
            }
        }

        function serveTable(t) {
            if (!t.customer || t.customer.served || !player.platedDish) return;
            if (player.platedDish === t.customer.order) {
                const base = recipes[t.customer.order].tip;
                const bonus = Math.floor((t.customer.patience / t.customer.maxPatience) * base);
                gameState.tips += base + bonus;
                gameState.dayTips += base + bonus;
                gameState.served++;
                gameState.dayServed++;
                t.customer.served = true;
                player.platedDish = null;
                player.hasPlate = false;
            }
        }

        function findRecipe(ings) {
            const sorted = [...ings].sort().join(',');
            for (const [name, recipe] of Object.entries(recipes)) {
                if ([...recipe.ingredients].sort().join(',') === sorted) return { name, recipe };
            }
            return null;
        }

        function getDistance(x1, y1, x2, y2) {
            return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
        }

        // ==========================================
        // CUSTOMERS
        // ==========================================
        function spawnCustomerLoop() {
            if (!gameState.running) return;
            const empty = tables.filter(t => !t.customer);
            if (empty.length > 0 && customers.length < 6) {
                spawnCustomer(empty[Math.floor(Math.random() * empty.length)]);
            }
            const delay = Math.max(3000, 8000 - gameState.day * 500);
            setTimeout(spawnCustomerLoop, delay + Math.random() * 3000);
        }

        function spawnCustomer(table) {
            const order = Object.keys(recipes)[Math.floor(Math.random() * Object.keys(recipes).length)];
            const patience = Math.max(20000, 45000 - gameState.day * 2000);
            const customer = {
                character: characters[Math.floor(Math.random() * characters.length)],
                order, patience, maxPatience: patience, served: false, angry: false
            };
            table.customer = customer;
            customers.push(customer);
        }

        // ==========================================
        // UI
        // ==========================================
        function updateInventoryUI() {
            const items = document.getElementById('invItems');
            const plate = document.getElementById('invPlate');
            items.innerHTML = '';
            plate.innerHTML = '';
            plate.classList.remove('has-plate');

            if (player.platedDish) {
                plate.classList.add('has-plate');
                const img = getDishImage(player.platedDish);
                if (img) {
                    const el = document.createElement('img');
                    el.src = img.src;
                    plate.appendChild(el);
                }
            } else if (player.hasPlate) {
                plate.classList.add('has-plate');
                const el = document.createElement('img');
                el.src = 'images/plate.svg';
                plate.appendChild(el);
            }

            player.holding.forEach(ing => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                const img = document.createElement('img');
                img.src = `images/food-${ing}.svg`;
                div.appendChild(img);
                items.appendChild(div);
            });
        }

        // ==========================================
        // DAY MANAGEMENT
        // ==========================================
        function endDay() {
            gameState.running = false;
            document.getElementById('dayServed').textContent = gameState.dayServed;
            document.getElementById('dayTips').textContent = '$' + gameState.dayTips;
            document.getElementById('dayComplete').classList.add('show');
        }

        function startNextDay() {
            document.getElementById('dayComplete').classList.remove('show');
            gameState.day++;
            if (gameState.day > CONFIG.MAX_DAYS) {
                document.getElementById('winScreen').classList.add('show');
                return;
            }
            gameState.running = true;
            resetDay();
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
            spawnCustomerLoop();
        }

        // ==========================================
        // INPUT
        // ==========================================
        function setupInput() {
            document.addEventListener('keydown', e => {
                if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') keys.up = true;
                if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') keys.down = true;
                if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') keys.left = true;
                if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') keys.right = true;
                if (e.key === ' ' || e.key === 'e' || e.key === 'E') { e.preventDefault(); interact(); }
            });

            document.addEventListener('keyup', e => {
                if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') keys.up = false;
                if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') keys.down = false;
                if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') keys.left = false;
                if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') keys.right = false;
            });

            document.querySelectorAll('.dpad-btn').forEach(btn => {
                const dir = btn.dataset.dir;
                btn.addEventListener('touchstart', e => { e.preventDefault(); keys[dir] = true; });
                btn.addEventListener('touchend', e => { e.preventDefault(); keys[dir] = false; });
                btn.addEventListener('mousedown', () => keys[dir] = true);
                btn.addEventListener('mouseup', () => keys[dir] = false);
                btn.addEventListener('mouseleave', () => keys[dir] = false);
            });

            document.getElementById('actionBtn').addEventListener('click', interact);
            document.getElementById('actionBtn').addEventListener('touchstart', e => { e.preventDefault(); interact(); });
        }

        // ==========================================
        // START
        // ==========================================
        loadAllImages();
    </script>
</body>
</html>
